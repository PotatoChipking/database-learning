# 标题：SLM-DB: Single-Level Key-Value Store with Persistent Memory

## 🍅摘要：

This paper investigates how to leverage emerging byteaddressable persistent memory (PM) to enhance the performance of key-value (KV) stores. We present a novel KV store, the Single-Level Merge DB (SLM-DB), which takes advantage of both the B+-tree index and the Log-Structured Merge Trees (LSM-tree) approach by making the best use of fast persistent memory. Our proposed SLM-DB achieves high read performance as well as high write performance with low write ampliﬁcation and near-optimal read ampliﬁcation. In SLM-DB, we exploit persistent memory to maintain a B+-tree index and adopt an LSM-tree approach to stage inserted KV pairs in a PM resident memory buffer. SLM-DB has a single-level organization of KV pairs on disks and performs selective compaction for the KV pairs, collecting garbage and keeping the KV pairs sorted sufﬁciently for range query operations. Our extensive experimental study demonstrates that, in our default setup, compared to LevelDB, SLM-DB provides 1.07 - 1.96 and 1.56 - 2.22 times higher read and write throughput, respectively, as well as comparable range query performance.

📅学习日期：2023-06-07
🍤作者：Kaiyrakhmet Olzhas,Lee Songyi,Nam Beomseok,Noh Sam H,Choi Young-ri
🍎出版年份：
✉️刊于：
☀️影响因子：

## 🏁研究背景：

PM存储设备在提供持久性的同时，具备更高的读写性能。

两种主流的kv存储类型：B+树和LSM Tree。

B+树：写性能较差，因为其随机写需要read-modify-write，而且叶子节点过大导致的SMO也会引起写放大问题。因此更适合读密集存储。

LSM Tree：写入性能较好，但是存在读写放大问题，更为适合写密集型的负载。

对读写操作性能要求较高的数据密集型应用的需求日益增长，像yahoo，数据表明读写需求近似。

因此，对于读和写工作负载，优化KV存储非常重要。

PM设备由英特尔公司研发，预计能达到DRAM相当的读取延迟，写入延迟大概五倍，带宽也低5-10倍。

PM也许会与SSD、HDD等设备共同使用。

## 🍚研究对象：

研究如何利用可字节寻址的PM设备来提高kv存储的性能。

提出一种单层的lsm tree，通过充分利用快速持久内存，同时利用B + - tree索引和日志结构合并树( LSM-tree )方法。

重新设计了compaction策略，利用PM特性取消了WAL。

通过B+tree索引，取消了全局SSTable的排序要求（空间放大、提高查询效率。）。

对LevelDB进行分析。

![SlimDB](D:\文件库\研究生\Learner\笔记\SlimDB.png)

## 🍟实现方案：

利用B+树索引和LSM Tree的优点，以及PM的性能，设计了Single-Level Merge DB（SLM-DB）。

LevelDB复用：

1、memtable和immutable。

2、sstable组织结构和文件格式。

3、lsm tree索引结构--维护有效sstable和其元数据、记录结构变化的日志--MANIFEST文件以及故障恢复模式。

使用**FAST and FAIR B+tree**作为索引。

利用PM设备特性，不需要WAL来实现数据的持久性。

重新设计了levelDB的随机读和范围查询操作。

![SlimDB2](D:\文件库\研究生\Learner\笔记\SlimDB2.png)



1、利用PM：

1、将Memtable与Immutable存入PM中，利用PM的非易失性，从而避免写入WAL再写入memtable的额外开销。

2、维护全局的B+树，对kv-file进行索引，从而加速查询、范围查询。

3、利用PM8bytes的原子操作，实现跳表的插入、删除操作的原子性。

4、B+树：

当kv从PM写入SSTable时，key会写入B+树中，与一个指向存储包含kv所在磁盘位置的PM object指针一起存储。

磁盘位置信息包括：SSTable文件ID、block offset以及block size。

存储时，会将string类型的key转化为int类型。

写入时间：

在flush时会创建两个后台线程，一个负责写入SSTable，另一个负责写入B+树。

SSTable：将所有存入新创建的文件中的KV条目加入一个由B+tree插入线程创建的队列中。

B+树：处理在队列中的KV条目，直到队列为空时，插入结束。

flush结束后，LSM Tree结构的变化会写入到MANIFEST文件中，作为日志，然后删除immutable。

扫描：

实现了iterator负责kv的扫描。提供seek、value、next方法。

2、日志结构追加存储：

1、以单层的方式存储数据，而不会对数据进行合并、重写，从而避免写放大。

3、对合并策略进行重新设计：

compaction用于1、收集失效的key，减少空间放大。2、提高kv在SSTable中的顺序性。

SLM实现了合并候选列表，计算s与列表中其他SSTables的每一个t的关键范围的重叠比例。

![img](data:image/png;base64,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)

即并集/交集，选择列表中重叠比例最高的SSTable进行合并。

compaction时，会新建文件，此时与flush操作一致，创建两个线程，分别写入SSTable和B+树。

然后修改元数据、删除合并的SSTable。共有三种选择策略：

1、活跃key比率：

维护每个SSTable中，活跃key与所有key的比例，当该比例低于threhold时，该SSTable被选择。

通过更新B+树时，找到修改的key所在的SSTable，从而修改该SSTable的比例。

2、叶子节点扫描：

以轮询的方式扫描一定数量的叶子节点key，扫描过程中记录出现过一次的SSTable文件，如果该数量超过阈值，选中添加到合并候选列表。

扫描的数量由两个因素确定：单个SSTable中存储key数量的均值、一次扫描中SSTable的数量。

3、范围查找顺序程度：

在执行范围查询时，将查询的key范围划分为若干子范围。

对于每个子范围，为每一个key追踪所在的SSTable，记录唯一出现的SSTable文件。当范围查询结束时，找到唯一文件数量最多的子范围。

判断文件数量与threhold，若超过，则加入候选列表。

为故障恢复：

将候选列表、总KV对数量以及每个SSTable的有效KV对数量添加到SSTable元数据文件中。manifest。

对于compaction，记录日志用于故障恢复，合并完成后进行删除。

4、提供接口：

put：先写内存、再写SSTable与B+树，或许通过compaction写入另一个文件中。

get：先查询内存，然后查找B+树，定位到SSTable，然后进行查找。

range query：使用B+树iterator，通过seek定位到开始key，通过next、value对范围中的key进行搜索。

5、崩溃恢复：

利用PM的原子操作实现内存组件的原子性，从而不需要记录redo log。

对于compaction，记录操作日志。

对于候选名单，若丢失，可以再次进行选择，不会影响数据。

若在写入B+树后，更新元数据前崩溃，此时B+树中指向新的文件，而原文件未删除，需要在下次compaction时对指针进行更新。

## 🍒总结评估：

Referred in [区块链存储优化学习](zotero://note/u/2Y9JV3V2/?ignore=1&line=312)